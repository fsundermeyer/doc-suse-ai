[#rancher-installation-airgapped-kubernetes]
ifdef::override-title[]
= {override-title}
endif::[]
ifndef::override-title[]
= Installing {ranchermanager} in air-gapped environments: install {kube}
endif::[]


This section describes how to install a {k8s} cluster according to our best practices for the {ranchera} server environment.
This cluster should be dedicated to running only the {ranchera} server.

[NOTE]
====
Skip this section if you are installing {ranchera} on a single node with {docker}.
====

{ranchera} can be installed on any {kube} cluster, including hosted {kube} providers.
The following sections outline how to set up an air-gapped {rke2a} cluster.
In this guide, we are assuming you have created your nodes in your air-gapped environment and have a secure {docker} private registry on your bastion server.

[#rancher-airgap-rke2-create-config]
== Create {rke2a} configuration

Create the `config.yaml` file at `/etc/rancher/rke2/config.yaml`.
This will contain all the configuration options necessary to create a highly available {rke2a} cluster.
On the first server, the minimum configuration is:

[source]
----
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
----

On each other server, the configuration file should contain the same token and tell {rke2a} to connect to the existing first server:

[source]
----
server: https://ip-of-first-server:9345
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
----

For more information, refer to the link:https://documentation.suse.com/cloudnative/rke2/latest/en/install/ha.html[RKE2 documentation].

[NOTE]
====
{rke2a} additionally provides a `resolv-conf` option for kubelets, which may help with configuring DNS in air-gap networks.
====

[#rancher-airgap-rke2-create-registry-yaml]
== Create registry YAML file

Create the `registries.yaml` file at `/etc/rancher/rke2/registries.yaml`.
This will tell {rke2a} the necessary details to connect to your private registry.
The `registries.yaml` file should look like this before plugging in the necessary information:

[source]
----
---
mirrors:
  customreg:
    endpoint:
      - "https://ip-to-server:5000"
configs:
  customreg:
    auth:
      username: xxxxxx # this is the registry username
      password: xxxxxx # this is the registry password
    tls:
      cert_file: _path to the cert file used in the registry_
      key_file:  _path to the key file used in the registry_
      ca_file: _path to the ca file used in the registry_
----

For more information on the private registry configuration file for {rke2a}, refer to the link:https://documentation.suse.com/cloudnative/rke2/latest/en/install/containerd_registry_configuration.html[RKE2 documentation.].

[#rancher-airgap-rke2-install-rke2]
== Install {rke2a}

{ranchera} needs to be installed on a supported {kube} version.
To find out which versions of {kube} are supported for your {ranchera} version, refer to link:https://rancher.com/support-maintenance-terms/[support maintenance terms].
Download the install script, rke2, rke2-images and sha256sum archives from the release and upload them into a directory on each server:

[source, subs="+attributes"]
----
{prompt_user}mkdir /tmp/rke2-artifacts && cd /tmp/rke2-artifacts/
{prompt_user}wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/rke2-images.linux-amd64.tar.zst
{prompt_user}wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/rke2.linux-amd64.tar.gz
{prompt_user}wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/sha256sum-amd64.txt
{prompt_user}curl -sfL https://get.rke2.io --output install.sh
----

Next, run `install.sh` using the directory on each server, as in the example below:

[source, subs="+attributes"]
----
{prompt_user}INSTALL_RKE2_ARTIFACT_PATH=/tmp/rke2-artifacts sh install.sh
----

Then enable and start the service on all servers:

[source, subs="+attributes"]
----
{prompt_sudo}systemctl enable rke2-server.service
{prompt_sudo}systemctl start rke2-server.service
----

For more information, refer to the xref:rke2-installation-airgapped[].

[#rancher-airgap-rke2-use-kubeconfig]
== Save and start using the kubeconfig file

When you installed {rke2a} on each {ranchera} server node, a `kubeconfig` file was created on the node at `/etc/rancher/rke2/rke2.yaml`.
This file contains credentials for full access to the cluster, and you should save this file in a secure location.
To use this `kubeconfig` file:

. Install link:https://{kube}.io/docs/tasks/tools/install-kubectl/#install-kubectl[kubectl], the {kube} command-line tool.
. Copy the file at `/etc/rancher/rke2/rke2.yaml` and save it to the directory `~/.kube/config` on your local machine.
. In the `kubeconfig` file, the `server` directive is defined as localhost.
Configure the server as the DNS for your load balancer, referring to port 6443.
(The {kube} API server will be reached at port 6443, while the {ranchera} server will be reached at ports 80 and 443.)
Here is an example `rke2.yaml`:

[source]
----
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: _[CERTIFICATE-DATA]_
    server: _[LOAD-BALANCER-DNS]_:6443 # Edit this line
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    password: _[PASSWORD]_
    username: admin
----

*Result:* You can now use `kubectl` to manage your {rke2a} cluster.
If you have more than one `kubeconfig` file, you can specify which one you want to use by passing in the path to the file when using `kubectl`:

[source, subs="+attributes"]
----
{prompt_user}kubectl --kubeconfig ~/.kube/config/rke2.yaml get pods \
  --all-namespaces
----

For more information about the `kubeconfig` file, refer to the link:https://documentation.suse.com/cloudnative/rke2/latest/en/cluster_access.html[{rke2a} documentation] or the link:https://{kube}.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/[official {kube} documentation] about organizing cluster access using `kubeconfig` files.

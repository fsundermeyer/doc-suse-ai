[#suse-security-installation-airgapped]
= Installing {ssecurity} in air-gapped environments

Follow the information in this section to perform an air-gapped deployment of {ssecurity}.

[#suse-security-airgapped-tools-needed]
== Required tools

We need to install three tools for downloading all components of {ssecurity}.

* link:https://helm.sh/[{helm}] - Application Lifecycle Manager
* link:https://github.com/containers/skopeo[Skopeo] - Image/Registry Tool
* link:https://github.com/facebook/zstd[ZStandard] - Compression Algorithm

. Install {helm}.
[source, subs="+attributes"]
----
 {prompt_user}curl -fsSL \
  https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash 
----
. Install {skopeo} and `zstd`.
[source, subs="+attributes"]
----
 {prompt_sudo}zypper update && zypper install zstd skopeo -y
----

[#suse-security-airgapped-get-images-chart]
== Get images and a {helm} chart

To get all the needed images, use the chart itself.
Using {helm}, add the repo and download the chart.
Use {skopeo} for downloading and uploading.

. Create a directory for the images.
[source, subs="+attributes"]
----
{prompt_user}{prompt_user}mkdir -p neuvector/images
----
. Add a {neuvector} repository.
[source, subs="+attributes"]
----
{prompt_user}helm repo add neuvector \
  https://neuvector.github.io/neuvector-helm/
----
. Download the latest {neuvector} chart.
[source, subs="+attributes"]
----
{prompt_user}helm repo update \
  && helm pull neuvector/core -d neuvector
----
. You should see a file named `core-X.Y.Z.tgz`.
To obtain the list of required images, run the following command:
[source, subs="+attributes"]
----
{prompt_user}helm template neuvector/core-*.tgz \
  | awk '$1 ~ /image:/ {print $2}' | sed -e 's/\"//g' \
  > neuvector/images/list.txt
----
. Download the images based on the generated list.
[source]
----
for i in $(cat neuvector/images/list.txt); do \
  skopeo copy docker://$i docker-archive:neuvector/images/$(echo $i| awk -F/ '{print $3}'|sed 's/:/_/g').tar:$(echo $i| awk -F/ '{print $3}') \
done
----
. Now you have a directory similar to the following one:
[source, subs="+attributes"]
----
{prompt_user}ls -lR neuvector
neuvector:
total 16
-rw-r--r--. 1 root root 15892 Jan  8 14:33 core-2.4.0.tgz
drwxr-xr-x. 2 root root   153 Jan  8 14:35 images

neuvector/images:
total 953920
-rw-r--r--. 1 root root 236693504 Jan  8 14:35 controller_5.3.2.tar
-rw-r--r--. 1 root root 226704384 Jan  8 14:35 enforcer_5.3.2.tar
-rw-r--r--. 1 root root       176 Jan  8 14:34 list.txt
-rw-r--r--. 1 root root 331550208 Jan  8 14:35 manager_5.3.2.tar
-rw-r--r--. 1 root root 169589760 Jan  8 14:35 scanner_latest.tar
-rw-r--r--. 1 root root  12265472 Jan  8 14:35 updater_latest.tar
----

[#suse-security-airgapped-compress-move]
== Compress and move the images to the local network

Use `tar` with the ZST format for maximum compression level.

[source, subs="+attributes"]
----
{prompt_user}tar -I zstd -vcf neuvector_airgap.zst neuvector
----

Move the created `neuvector_airgap.zst` archive to the isolated local network.

[#suse-security-airgapped-uncompress-load]
== Uncompress and load the images

Uncompress the images from the archive.
The following example leaves them in the `neuvector` directory.

[source, subs="+attributes"]
----
{prompt_user}tar -I zstd -vxf neuvector_airgap.zst
----

Loading the images into a local image registry requires you to understand your local network.
This example uses `registry.awesome.sauce` as the DNS name.
Loading the images is done with the `skopeo` command.
Make sure that `skopeo` is installed on the air-gapped local machine.
You may need to authenticate with `skopeo login` first.

[source, subs="+attributes"]
----
{prompt_user} export REGISTRY=registry.awesome.sauce
for file in $(ls neuvector/images | grep -v txt ); do
     skopeo copy docker-archive:neuvector/images/$file docker://$(echo $file | sed 's/.tar//g' | awk -F_ '{print "'$REGISTRY'/neuvector/"$1":"$2}')
done
----

With all the images loaded in a local image registry, you can install using {helm}.

[#suse-security-airgapped-deploy-helm]
== Install the transferred images on a local cluster

To install the images from the local registry, you must override `REGISTRY` and `NEU_URL` variables.
Also, adjust the `imagePullSecrets` option to include the secret for your cluster to authenticate to the registry.

[source, subs="+attributes"]
----
{prompt_user}export REGISTRY=registry.awesome.sauce
{prompt_user}export NEU_URL=neuvector.awesome.sauce
{prompt_user}helm upgrade -i neuvector --namespace neuvector neuvector/core \
--create-namespace --set imagePullSecrets=regsecret --set k3s.enabled=true \
--set k3s.runtimePath=/run/k3s/containerd/containerd.sock \
--set manager.ingress.enabled=true --set controller.pvc.enabled=true \
--set controller.pvc.capacity=10Gi --set manager.svc.type=ClusterIP \
--set registry=$REGISTRY --set tag=5.3.2 \
--set controller.image.repository=neuvector/controller \
--set enforcer.image.repository=neuvector/enforcer \
--set manager.image.repository=neuvector/manager \
--set cve.updater.image.repository=neuvector/updater \
--set manager.ingress.host=$NEU_URL
----

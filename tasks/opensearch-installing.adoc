[#opensearch-installing]
= Installing {opensearch}

{opensearch} is a community-driven, open source search and analytics suite.
It is used to search, visualize and analyze data.
{opensearch} consists of a data store and search engine ({opensearch}), a visualization and user interface ({opensearch} Dashboards), and a server-side data collector (Data Prepper).
Its functionality can be extended by plug-ins that enhance features like search, analytics, observability, security or machine learning.

[#opensearch-installing-app-details]
== Details about the {opensearch} application

Before deploying {opensearch}, it is important to know more about the supported configurations and documentation.
The following command provides the corresponding details:

[source,bash]
----
helm show values oci://dp.apps.rancher.io/charts/opensearch
----

Alternatively, you can also refer to the {opensearch} {helm} chart page on the {sappco} site at link:https://apps.rancher.io/applications/opensearch[].
It contains {opensearch} dependencies, available versions and the link to pull the {opensearch} container image.

[#opensearch-installing-procedure]
== {opensearch} installation procedure

{opensearch} can operate as a single-node or multi-node cluster.
The following override file examples outline both scenarios.

[IMPORTANT]
====
Both scenarios require increasing the value of the `vm.max_map_count` to at least 262144.
To check the current value, run the following command:

[source,bash,subs="+attributes"]
----
{prompt_user}cat /proc/sys/vm/max_map_count
----

To increase the value, add the following to `/etc/sysctl.conf`:

[source]
----
vm.max_map_count=262144
----

Then run `sudo sysctl -p` to reload.
====

include::../snippets/ai-library-requirement.adoc[]

. Create an `opensearch_custom_overrides.yaml` file to override the default values of the {helm} chart.
+
For a single-node cluster, use the following template file:
+
[source,yaml]
----
# opensearch_custom_overrides.yaml
global:
  imagePullSecrets:
    - application-collection
singleNode: true
replicas: 1
persistence:
  enabled: true
  storageClass: local-path

extraEnvs:
  - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
    value: "MySecurePass123"

service:
  type: NodePort
  httpPort: 9200
  transportPort: 9300
  metricsPort: 9600

resources:
  limits:
    memory: "6Gi"
    cpu: "2"

config:
  opensearch.yml: |
    plugins.security.disabled: true
----
+
For a multi-node cluster, use the following template file:
+
[source,yaml]
----
# opensearch_custom_overrides.yaml
global:
  imagePullSecrets:
    - application-collection
singleNode: false
replicas: 3
persistence:
  enabled: true
  storageClass: local-path

extraEnvs:
  - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
    value: "MySecurePass123"
  - name: ES_JAVA_OPTS
    value: "-Xms3g -Xmx3g" 

service:
  type: NodePort
  httpPort: 9200
  transportPort: 9300
  metricsPort: 9600

resources:
  limits:
    memory: "6Gi"
    cpu: "2"
  requests:
    memory: "4Gi"
    cpu: "1"

startupProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 12

readinessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

livenessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 120
  periodSeconds: 20
  timeoutSeconds: 5
  failureThreshold: 3

config:
  opensearch.yml: |
    plugins.security.disabled: true
----
. After saving the override file as `opensearch_custom_overrides.yaml`, apply its configuration with the following command.
+
[source,bash,subs="+attributes"]
----
{prompt_user}helm upgrade --install \
  opensearch oci://dp.apps.rancher.io/charts/opensearch \
  -n <SUSE_AI_NAMESPACE> \
  -f <opensearch_custom_overrides.yaml>
----
. Check that the pods and services are running.
+
[source,bash,subs="+attributes"]
----
{prompt_user}kubectl get pods -n <SUSE_AI_NAMESPACE> | grep "opensearch"
opensearch-cluster-master-0           1/1     Running   0          5h34m
----
+
A multi-node cluster configuration shows that the replicas are distributed across multiple nodes.
+
[source,bash,subs="+attributes"]
----
{prompt_user}kubectl get pods -n <SUSE_AI_NAMESPACE> | grep "opensearch"
opensearch-cluster-master-0 1/1 Running 0 2m30s 10.42.1.32 mgmt-rancher-wkrgpu1
opensearch-cluster-master-1 1/1 Running 0 2m30s 10.42.1.33 mgmt-rancher-wkrgpu1
opensearch-cluster-master-2 1/1 Running 0 2m30s 10.42.0.27 mgmt-rancher
----

[#opensearch-owui-integration]
== Integrating {opensearch} with {owui}

To integrate {opensearch} with {owui}, follow these steps:

. Edit the override file for {owui}, `owui_custom_overrides.yaml`, and update the `extraEnvVars` section as follows.
+
* Change the `VECTOR_DB` value to `opensearch`.
* Remove the `MILVUS_URI` variable.
* Add all the {opensearch}-related environment variables.
+
[source,yaml]
----
extraEnvVars:
- name: DEFAULT_MODELS
  value: "gemma:2b"
- name: DEFAULT_USER_ROLE
  value: "pending"
- name: ENABLE_SIGNUP
  value: "true"
- name: GLOBAL_LOG_LEVEL
  value: INFO
- name: RAG_EMBEDDING_MODEL
  value: "sentence-transformers/all-MiniLM-L6-v2"
- name: INSTALL_NLTK_DATASETS
  value: "true"
- name: VECTOR_DB
  value: "opensearch"
#- name: MILVUS_URI
#  value: http://milvus.<SUSE_AI_NAMESPACE>.svc.cluster.local:19530
- name: OPENAI_API_KEY
  value: "0p3n-w3bu!"
- name: OPENSEARCH_SSL
  value: "false"
- name: OPENSEARCH_URI
  value: http://opensearch-cluster-master.<SUSE_AI_NAMESPACE>.svc.cluster.local:9200
- name: OPENSEARCH_USERNAME
  value: admin
- name: OPENSEARCH_PASSWORD
  value: MySecurePass123
- name: OPENSEARCH_CERT_VERIFY
  value: "false"
----
. Redeploy {owui}.
+
[source,bash,subs="+attributes"]
----
{prompt_user}helm upgrade --install \
  open-webui oci://dp.apps.rancher.io/charts/open-webui \
  -n <SUSE_AI_NAMESPACE> \
  -f <owui_custom_overrides.yaml>
----
. Verify that `VECTOR_DB` is set to `opensearch`.
+
[source,bash,subs="+attributes"]
----
{prompt_user}kubectl exec -it open-webui-0 -n <SUSE_AI_NAMESPACE> \
  -- sh -c 'echo "VECTOR_DB=$VECTOR_DB"'

Defaulted container "open-webui" out of: open-webui, copy-app-data (init)
VECTOR_DB=opensearch
----

ifdef::deployment_standard[]
[#opensearch-upgrading]
== Upgrading {opensearch}

The {opensearch} chart receives application updates and updates of the {helm} chart templates.
New versions may include changes that require manual steps.
These steps are listed in the corresponding `README` file.
All {opensearch} dependencies are updated automatically during an {opensearch} upgrade.

To upgrade {opensearch}, identify the new version number and run the following command below:

[source,bash,subs="+attributes"]
----
{prompt_user}helm upgrade --install \
  opensearch oci://dp.apps.rancher.io/charts/opensearch \
  -n <SUSE_AI_NAMESPACE> \
  --version <VERSION_NUMBER> \
  -f <opensearch_custom_overrides.yaml>
----

[TIP]
====
If you omit the `--version` option, {opensearch} gets upgraded to the latest available version.
====
endif::[]

[#opensearch-uninstalling]
== Uninstalling {opensearch}

To uninstall {opensearch}, run the following command:

[source,bash,subs="+attributes"]
----
{prompt_user}helm uninstall opensearch -n <SUSE_AI_NAMESPACE>
----
